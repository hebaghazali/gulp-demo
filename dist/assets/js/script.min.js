var req=new XMLHttpRequest,url="http://localhost:3000",posts=[],users=[],user={},post={},comments=[],postOb={id:"",createdAt:"",text:"",video:"",image:"",commentsNum:0,likesNum:0,retweetsNum:0,user:{},comments:[],usersLikes:[],usersRetweets:[]};function News(e,t,s){this.category=e,this.image=t,this.content=s}function loadPage(e){getUser(localStorage.getItem("currentUser")?localStorage.getItem("currentUser"):sessionStorage.getItem("currentUser")),"home"==e&&(setTimeout((()=>{getPosts()}),400),setTimeout((()=>{displayPosts(posts)}),450),setTimeout((()=>{displayAddTweet()}),500)),"tweet"==e&&displayTweetPage(),"profilepage"==e&&(setTimeout((()=>{displayProfile()}),400),setTimeout((()=>{getPosts()}),450),setTimeout((()=>{displayPosts(posts.filter((e=>e.user.id==user.id)))}),500)),"bookmarks"==e&&(setTimeout((()=>{getPosts()}),400),setTimeout((()=>{displayBookmarks()}),650)),setTimeout((()=>{displayAsideUser()}),450),setTimeout((()=>{getUsers()}),600),setTimeout((()=>{displayNews()}),750),"whoTofollow"==e?setTimeout((()=>{displayUsers(users.length)}),700):setTimeout((()=>{displayUsers(3)}),700)}function displayAddTweet(){document.getElementById("profile").src=user.img}function displayAsideUser(){console.log(user),document.getElementById("aside-profile").src=user.img,document.getElementById("aside-name").innerHTML=user.name,document.getElementById("aside-user-name").innerHTML=user.userName}function getPosts(e=""){req.open("GET",url+"/posts?"+e),req.send(),req.onreadystatechange=()=>{4==req.readyState&&200==req.status&&(posts=JSON.parse(req.responseText))}}function getComments(e=""){req.open("GET",url+"/comments?"+e),req.send(),req.onreadystatechange=()=>{4==req.readyState&&200==req.status&&(comments=JSON.parse(req.responseText),console.log("commmmmments",comments))}}function getUsers(){req.open("GET",url+"/users"),req.send(),req.onreadystatechange=()=>{4==req.readyState&&200==req.status&&(users=JSON.parse(req.responseText),console.log("users===========================",users))}}function getUser(e){req.open("GET",url+"/users/"+e),req.send(),req.onreadystatechange=()=>{4==req.readyState&&200==req.status&&(user=JSON.parse(req.responseText),console.log("user>>>>>>>",user))}}function addRequest(e,t){req.open("POST",e),console.log(JSON.stringify(t)),req.setRequestHeader("Content-Type","application/json;charset=UTF-8");try{req.send(JSON.stringify(t)),req.onreadystatechange=()=>{console.log("on state change",req),4==req.readyState&&(200==req.status?console.log("Done",data):console.log("error",req.responseText))}}catch(e){console.log(">>>>>>>>>error",e)}}function displayPosts(e){document.getElementsByClassName("lds-ring")[0].classList.add("hidden");var t=0;e.forEach((e=>{var s;(document.getElementsByClassName("homepage")[0].innerHTML+=postContent(e,t),e.usersLikes.includes(parseInt(user.id)))?((s=document.getElementById(`like-btn-${t}`)).classList.add("liked-post-style"),s.title="dislike"):(s=document.getElementById(`like-btn-${t}`)).classList.remove("liked-post-style");var n=document.getElementById(`retweet-btn-${t}`);e.usersRetweets.includes(parseInt(user.id))?(n.classList.add("retweeted-post-style"),n.title="Undo Retweet"):n.classList.remove("retweeted-post-style");var o=document.getElementById(`share-btn-${t}`);user.bookmarks.includes(parseInt(e.id))?o.classList.add("bookmarked-post-style"):o.classList.remove("bookmarked-post-style"),t++}))}function displayCard(e,t){var s=document.getElementById(e.target.parentElement.parentElement.parentElement.parentElement.id);null==s&&(s=document.getElementById(e.target.parentElement.id));var n=users[t-1],o=document.createElement("div");o.setAttribute("id","card-id"),o.setAttribute("class","profile-card"),o.style.display="block",o.innerHTML=userCardContent(n),s.appendChild(o),o.onmouseleave=function(){s.removeChild(o)}}function displayUsers(e){var t=document.createElement("section");t.classList.add("users-section"),t.innerHTML='<p class="section-title">Who to follow</p>',users.slice(0,e).forEach((e=>{var s=document.createElement("div");s.classList.add("section-user"),s.innerHTML=userRow(e),t.appendChild(s)})),t.innerHTML+='<div class="section-user"> <a class=\'moreFollowers\' href="WhoToFollow.html">Show more</a></div>',document.getElementById("asideUsers").appendChild(t)}function toggleFollow(e){e.stopPropagation(),console.log(e.target.innerHTML);var t=e.target;console.log(t.innerHTML),"Follow"==t.innerHTML?(t.innerHTML="Following",t.classList.add("unfollow-btn")):(t.innerHTML="Follow",t.classList.remove("unfollow-btn"))}function likePost(e,t,s){e.stopPropagation();var n=document.getElementById(e.target.parentElement.id),o=posts[t-1].usersLikes,r=posts[t-1].likesNum,l={};if(l.usersLikes=o,n.classList.contains("liked-post-style")){n.classList.remove("liked-post-style"),l.likesNum=r-1;const e=l.usersLikes.indexOf(parseInt(s));e>-1&&l.usersLikes.splice(e,1)}else n.classList.add("liked-post-style"),l.likesNum=r+1,l.usersLikes.push(parseInt(s));EditPost(t,l)}function retweetPost(e,t,s){e.stopPropagation();var n=document.getElementById(e.target.parentElement.id),o={};if(o.usersRetweets=posts[t-1].usersRetweets,n.classList.contains("retweeted-post-style")){n.classList.remove("retweeted-post-style"),o.retweetsNum=posts[t-1].retweetsNum-1;const e=o.usersRetweets.indexOf(parseInt(s));e>-1&&o.usersRetweets.splice(e,1)}else n.classList.add("retweeted-post-style"),o.retweetsNum=posts[t-1].retweetsNum+1,o.usersRetweets.push(parseInt(s));EditPost(t,o)}function EditPost(e,t){var s=JSON.stringify(t);console.log(s),req.open("PATCH",url+"/posts/"+e),req.setRequestHeader("Content-Type","application/json;charset=UTF-8"),req.onreadystatechange=function(){var e=JSON.parse(req.responseText);4==req.readyState&&req.status,console.log(e)},req.send(s)}function addPost(e){var t=document.getElementById(e).value,s=parseInt(posts[posts.length-1].id);console.log(s);var n={...postOb};n.user=user,n.text=t,n.id=(++s).toString(),n.createdAt=new Date,posts.push(n),console.log("old",postOb),console.log("new",n),addRequest(url+"/posts",n)}function displayProfile(){document.getElementById("profile-cover-image").src="./assets/images/flowers.jpg",document.getElementById("profile-user-image").src=user.img,document.getElementById("profile-user-name").innerText=user.name,document.getElementById("name-span").innerText=user.name,document.getElementById("profile-user-username").innerText=user.userName,document.getElementById("profile-following").innerText=user.following,document.getElementById("profile-followers").innerText=user.followers}function goToPost(e){location.href="./comments.html",sessionStorage.setItem("tweet",e)}function displayTweetPage(){setTimeout((()=>{getPosts(`id=${sessionStorage.getItem("tweet")}`)}),400),setTimeout((()=>{displayPosts(posts)}),450),setTimeout((()=>{displayWriteReply()}),500),setTimeout((()=>{posts[0].commentsNum>0&&getComments("postId="+posts[0].id)}),550),setTimeout((()=>{posts[0].commentsNum>0&&displayPosts(comments)}),600)}function displayWriteReply(){document.getElementsByClassName("homepage")[0].innerHTML+=writeReplysection()}function HandleIconPost(e){e.stopPropagation();var t=document.getElementById(e.target.parentElement.parentElement.parentElement.parentElement.id);null==t&&(t=document.getElementById(e.target.parentElement.id));var s=t.getElementsByClassName("user-id")[0].innerText;getUser(s);req.open("GET",url+"/users/"+s),req.send(),req.onreadystatechange=()=>{4==req.readyState&&200==req.status&&(JSON.parse(req.responseText),setTimeout((function(){var e=document.createElement("div");e.setAttribute("id","caard-id"),e.setAttribute("class","div-icon-post"),e.style.display="block",e.innerHTML=' <div >\n          <ul>\n            <li> <i class="far fa-envelope"></i> <span> Send Direct Message</span></li>\n            <li> <i class="far fa-bookmark"></i> Bookmark</span></li>\n            <li> <i class="fas fa-link"></i> <span> Copy link to Tweet</span></li>\n            <li> <i class="fas fa-sign-out-alt"\n            style="transform: rotate(-90deg);"></i> <span> Share Tweet via ...</span></li>\n          </ul>\n        </div> ',t.appendChild(e),e.onmouseleave=function(){t.removeChild(e)}}),400))}}function addComment(e){var t=posts[0],s=document.getElementById(e).value,n={...postOb};n.user=user,n.text=s,n.id=Math.floor(1e3*Math.random()).toString(),n.createdAt=new Date,n.postId=t.id,comments.push(n),console.log("old",postOb),console.log("new",n);var o={};o.commentsNum=t.commentsNum+1,setTimeout((()=>{addRequest(url+"/comments",n)}),100),setTimeout((()=>{EditPost(t.id,o)}),250)}function addBookmark(e,t){e.stopPropagation(),console.log("bookmark",t,user);var s=document.getElementById(t);user.bookmarks.includes(t)?(s.classList.remove("bookmarked-post-style"),user.bookmarks.splice(user.bookmarks.indexOf(t),1)):(s.classList.add("bookmarked-post-style"),user.bookmarks.push(t),console.log(">>>",user));var n={};n.bookmarks=user.bookmarks,console.log("oc",n),req.open("PATCH",url+"/users/"+user.id),req.setRequestHeader("Content-Type","application/json;charset=UTF-8"),req.send(JSON.stringify(n))}function displayBookmarks(){document.getElementsByClassName("lds-ring")[0].classList.add("hidden"),document.getElementById("username-span").innerText=user.userName;var e=[];user.bookmarks.forEach((t=>{e.push(t.toString())}));var t=[];posts.forEach((s=>{e.includes(s.id)&&t.push(s)})),displayPosts(t)}function logout(){localStorage.clear(),location.replace("./Sign-in/sign.html")}function displayNews(){var e=[];e.push(new News("sports","https://pbs.twimg.com/semantic_core_img/1471063698596790272/sUFmtGGA?format=jpg&name=small","The Africa Cup of Nations due to be held in January 2022 has been indefinitely postponed, the Confederation of African Football has confirmed")),e.push(new News("news","https://pbs.twimg.com/media/FHdDaD1XMAUz46r?format=jpg&name=small","إطلاق أقوى تليسكوب في التاريخ لاستكشاف الفضاء")),e.push(new News("health","https://pbs.twimg.com/semantic_core_img/1366513874350923778/f6PSgcbJ?format=png&name=small","Experts say masks are safe and effective in preventing spread of COVID-19"));for(var t=document.getElementById("news-div"),s=0;s<e.length;s++)console.log(e),t.style.padding="15px 0px",t.innerHTML+=`\n    <div class="news-content">\n    <h4 style="font-size: 15px;font-weight: lighter;color: #8899a6;">${e[s].category}</h4>\n    <div style="display: flex;flex-direction: row;">\n      <p>${e[s].content}</p>\n      <img style="margin-left:5px;width: 70px;height: 60px;border-radius: 15px;" src="${e[s].image}"/>\n    </div>\n    <div>\n    `}function goTo(e,t){e.stopPropagation(),location.assign(t)}function postContent(e,t){return`\n    <div id=${e.id} class="post-container" onclick="goToPost(${e.id})" >\n         <label class="user-id" style="display:none">${e.user.id}</label>\n         <label class="users-likes" style="display:none">${e.usersLikes}</label>\n         <label class="users-retweets" style="display:none">${e.usersRetweets}</label>\n          <img class="logged-user-image profile-img" onmouseover='displayCard(event,${e.user.id})' src=${e.user.img} alt="profile-img"/>\n\n         \n          <div class="post-content">\n          \n      <div class="post-text">\n    \n        <div class="name-container">\n        \n          <h6 class="name-style" onmouseover='displayCard(event,${e.user.id})'>${e.user.name}</h6>\n                  <span class="username-style">@${e.user.userName}</span>\n        </div>\n\n        <button title="More"class="settings-btn" onclick=HandleIconPost(event) ><i class="fas fa-ellipsis-h"></i></button>    </div>\n           ${e.text&&`<article class="post-article">${e.text}</article>`}\n          ${e.image&&`<img class="post-media" src=${e.image} alt="post-media"/>`}\n          ${e.video&&'\n            <div class="post-media">\n            <iframe style="height: 350px;width:100%;border-radius:20px" src="https://www.youtube.com/embed/-p1P4fdhaF8" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>\n            </div>\n            '}\n\n\n          <footer class="post-footer" style="display: flex;">\n            <button class="reply-btn" title="Reply"><i class="far fa-comment"></i><label>${e.commentsNum}</label></button>\n            <button class="retweet-btn" id="retweet-btn-${t}" title="Retweet" onclick="retweetPost(event,${e.id},${user.id})"><i class="fas fa-retweet"></i><label class="retweets-num">${e.retweetsNum}</label></button>\n            <button class="like-btn" id="like-btn-${t}" title="Like" onclick="likePost(event,${e.id},${user.id})"><i class="fas fa-heart"></i><label class="likes-num">${e.likesNum}</label></button>\n            <button class="share-btn" id="share-btn-${t}" title="Share" onclick='addBookmark(event,${e.id})'><i class="fas fa-sign-out-alt"\n                style="transform: rotate(-90deg);"></i></button>\n          </footer>\n\n\n           </div>\n        </div>\n    `}function userCardContent(e){return`  <div style="float:left;display: flex;flex-direction: column;line-height: 1.5em;" onclick="stopParentC">\n  <img onclick="goTo(event,'profilepage.html')" id="selected-user-img" class="logged-user-image" src=${e.img}/>\n  <h6 id="selected-user-name" class="name-style" onclick="goTo(event,'profilepage.html')">${e.name}</h6>\n  <span id="selected-user-username" class="username-style" style="color:#8899A6;" onclick="goTo(event,'profilepage.html')">${e.userName}</span>\n</div>\n<button class="card-follow-btn" onclick="toggleFollow(event)">Follow</button>\n<p id="selected-user-bio" style="clear: both;padding: 5% 0%;line-height: 1.5em;">\n${e.bio}\n</p>\n<div>\n  <h4 id="selected-user-following" style="float: left;margin-right: 10%;" onclick="goTo(event,'WhoToFollow.html')">${e.following}<span style="color:#8899A6;font-weight: lighter;"> Following</span></h4>\n  <h4 id="selected-user-followers" onclick="goTo(event,'WhoToFollow.html')">${e.followers}<span style="color:#8899A6;font-weight: lighter;"> Followers</span></h4>\n</div>`}function writeReplysection(){return`\n         <div class="post replyContainer">\n         <img\n           class="profile-img"\n           id="profile"\n           style="border-radius: 50% ; width:60px"\n           src=${user.img}\n           alt="profile image"\n         />\n         <div class="post-right-side">\n           <input\n             id="write-header"\n             type="text"\n             placeholder="write your reply..."\n           />\n       \n         </div>\n         <button class="primary-btn tweet-btn" style="width:20%" onclick="addComment('write-header')">Reply</button>   \n        </div>\n    `}function userRow(e){return`\n    <div class="user-image">\n      <img src=${e.img} />\n    </div>\n    <div class="who-to-follow-user" style="width: 90%">\n      <div class="user-item">\n          <div style="padding-left: 2%;">\n            <h6 class="user-name">${e.name} </h6>\n            <h6 class="user-name op">@${e.userName} </h6>\n          </div>\n          <button onclick="toggleFollow(event)" class="follow-btn secondary-btn">Follow</button>\n        </div>\n      </div>\n    </div>\n    `}